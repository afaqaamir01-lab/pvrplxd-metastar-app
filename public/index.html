// NOTE: Deployed on Cloudflare Workers
// REPLACES: The previous worker.js (Removed Storage + Added Split Auth)

// --- 1. CONFIGURATION ---
// Ensure these match your Cloudflare Environment Variables exactly
// WHOP_COMPANY_ID, WHOP_PRODUCT_ID, WHOP_API_KEY, RESEND_API_KEY, JWT_SECRET

// --- 2. HELPER: DYNAMIC CORS ---
function getCorsHeaders(request) {
    const origin = request.headers.get("Origin");
    return {
        "Access-Control-Allow-Origin": origin || "*",
        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type, Authorization",
        "Access-Control-Allow-Credentials": "true" 
    };
}

function json(data, status = 200, headers = {}) {
  return new Response(JSON.stringify(data), { 
    headers: { ...headers, 'Content-Type': 'application/json' }, 
    status 
  });
}

// --- 3. HELPER: WHOP LICENSE CHECKER ---
async function checkWhopLicense(email, env) {
    const companyId = env.WHOP_COMPANY_ID; 
    const requiredProductId = env.WHOP_PRODUCT_ID ? env.WHOP_PRODUCT_ID.trim() : null;

    if (!companyId || !requiredProductId) throw new Error("Server Config Error");

    const whopRes = await fetch(`https://api.whop.com/v1/memberships?email=${encodeURIComponent(email)}&company_id=${companyId}`, {
        headers: { 'Authorization': `Bearer ${env.WHOP_API_KEY}` }
    });

    if (!whopRes.ok) return { valid: false, error: "Provider Error" };
    
    const whopData = await whopRes.json();
    
    // Strict Empty Check: If no memberships exist at all, fail immediately
    if (!whopData.data || !Array.isArray(whopData.data) || whopData.data.length === 0) {
        return { valid: false };
    }

    const validStatuses = ['active', 'trialing', 'paid_subscriber', 'completed'];

    // Find the specific matching product
    const match = whopData.data.find(m => {
        // IDs can be in m.product_id OR m.product.id depending on API version
        const pId = m.product_id || (m.product && m.product.id);
        const eId = m.experience_id || (m.experience && m.experience.id);
        
        const isTarget = (pId === requiredProductId) || (eId === requiredProductId);
        return isTarget && validStatuses.includes(m.status);
    });

    if (match) {
        // Return success and try to grab the plan name for UI display
        const planName = (match.plan && match.plan.name) ? match.plan.name : "Pro License";
        return { valid: true, productName: planName };
    }

    return { valid: false };
}

// --- 4. WORKER LOGIC ---
export default {
  async fetch(request, env, ctx) {
    const corsHeaders = getCorsHeaders(request);
    if (request.method === "OPTIONS") return new Response(null, { headers: corsHeaders });

    const url = new URL(request.url);
    const path = url.pathname;

    // --- ROUTE 1: HEALTH CHECK ---
    if (path === "/health") {
        const isMaintenance = await env.AUTH.get("maintenance");
        return json({ status: "ok", maintenance: isMaintenance === "true" }, 200, corsHeaders);
    }

    // --- ROUTE 2: CHECK LICENSE (Gatekeeper) ---
    // User enters email -> This runs. No email sent yet.
    if (path === "/auth/check" && request.method === "POST") {
        try {
            const { email } = await request.json();
            if (!email) return json({ message: "Email required" }, 400, corsHeaders);

            const result = await checkWhopLicense(email, env);
            
            if (result.valid) {
                return json({ success: true, product: result.productName }, 200, corsHeaders);
            } else {
                // Return 403 so UI knows to show "No License" error
                return json({ message: "No active subscription found.", code: "NO_SUBSCRIPTION" }, 403, corsHeaders);
            }
        } catch (e) {
            return json({ message: "Check failed" }, 500, corsHeaders);
        }
    }

    // --- ROUTE 3: SEND OTP (The Action) ---
    // User clicks "Verify" on the License Card -> This runs.
    if (path === "/auth/send" && request.method === "POST") {
      try {
        const { email } = await request.json();
        
        // A. Security: Rate Limiting
        const today = new Date().toISOString().split('T')[0];
        const sendCount = parseInt(await env.AUTH.get(`sends:${email}:${today}`) || "0");
        if (sendCount >= 8) return json({ message: "Daily limit reached." }, 429, corsHeaders);

        // B. Security: Re-Verify License (Prevent API Bypassing)
        const check = await checkWhopLicense(email, env);
        if (!check.valid) {
            return json({ message: "License validation failed." }, 403, corsHeaders);
        }

        // C. Generate & Save OTP
        const otp = Math.floor(100000 + Math.random() * 900000).toString();
        await env.AUTH.put(`otp:${email}`, JSON.stringify({ code: otp, attempts: 0 }), { expirationTtl: 300 });
        await env.AUTH.put(`sends:${email}:${today}`, (sendCount + 1).toString(), { expirationTtl: 86400 });

        // D. Send Email
        await fetch('https://api.resend.com/emails', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${env.RESEND_API_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                from: "MetaStar Security <auth@metastar.site>", 
                to: email, 
                subject: `Your Access Code: ${otp}`, 
                html: `
                <div style="font-family: sans-serif; text-align: center; padding: 20px;">
                    <h2>MetaStar Studio</h2>
                    <p>Your verification code is:</p>
                    <h1 style="font-size: 32px; letter-spacing: 5px; color: #000;">${otp}</h1>
                    <p style="color: #888; font-size: 12px;">This code expires in 5 minutes.</p>
                </div>`
            })
        });

        return json({ success: true }, 200, corsHeaders);

      } catch (e) { return json({ message: "Server Error" }, 500, corsHeaders); }
    }

    // --- ROUTE 4: VERIFY OTP ---
    if (path === "/auth/verify" && request.method === "POST") {
        try {
            const { email, code } = await request.json();
            const otpDataStr = await env.AUTH.get(`otp:${email}`);
            
            if (!otpDataStr) return json({ message: "Code expired." }, 403, corsHeaders);
            const otpData = JSON.parse(otpDataStr);

            if (otpData.code !== code) {
                otpData.attempts++;
                await env.AUTH.put(`otp:${email}`, JSON.stringify(otpData), { expirationTtl: 300 });
                return json({ message: "Incorrect code", attemptsRemaining: 3 - otpData.attempts }, 400, corsHeaders);
            }

            await env.AUTH.delete(`otp:${email}`);

            // JWT Generation
            const secret = new TextEncoder().encode(env.JWT_SECRET);
            const payload = { sub: email, exp: Math.floor(Date.now() / 1000) + 604800 }; 
            const header = btoa(JSON.stringify({ alg: "HS256", typ: "JWT" }));
            const body = btoa(JSON.stringify(payload));
            const sig = await crypto.subtle.sign("HMAC", await crypto.subtle.importKey("raw", secret, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]), new TextEncoder().encode(`${header}.${body}`));
            const token = `${header}.${body}.${btoa(String.fromCharCode(...new Uint8Array(sig))).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_')}`;

            return json({ valid: true, token: token }, 200, corsHeaders);

        } catch (e) { return json({ message: "Verify failed" }, 500, corsHeaders); }
    }

    // --- ROUTE 5: VALIDATE SESSION ---
    if (path === "/auth/validate" && request.method === "POST") {
        const authHeader = request.headers.get("Authorization");
        let token = authHeader && authHeader.startsWith("Bearer ") ? authHeader.split(" ")[1] : null;
        
        if (!token) return json({ valid: false }, 200, corsHeaders);

        // Simple Local Verification (Fast)
        try {
            const [h, b, s] = token.split('.');
            const payload = JSON.parse(atob(b));
            if (Date.now() / 1000 > payload.exp) throw new Error("Expired");
            return json({ valid: true, email: payload.sub }, 200, corsHeaders);
        } catch(e) {
            return json({ valid: false }, 200, corsHeaders);
        }
    }

    // --- ROUTE 6: SERVE CORE ---
    if (path === "/core.js") {
        const authHeader = request.headers.get("Authorization");
        if (!authHeader) return new Response("Unauthorized", { status: 401, headers: corsHeaders });
        
        try {
            let object = await env.ASSETS.get("core.js"); 
            if (object === null) object = await env.ASSETS.get("v2/core.js"); 
            if (object === null) return new Response("Core not found", { status: 404, headers: corsHeaders });
            
            const headers = new Headers(corsHeaders);
            object.writeHttpMetadata(headers);
            headers.set("etag", object.httpEtag);
            return new Response(object.body, { headers });
        } catch (e) { return new Response("Storage Error", { status: 500, headers: corsHeaders }); }
    }
  
    return new Response("Not Found", { status: 404, headers: corsHeaders });
  }
};
