export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    
    // CORS Setup
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*", // Or restricts to your domain: "https://metastar.vercel.app"
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization",
    };

    if (request.method === "OPTIONS") return new Response(null, { headers: corsHeaders });

    // --- 1. AUTH INITIALIZATION ---
    if (url.pathname === "/auth/init" && request.method === "POST") {
      try {
        const { email } = await request.json();
        if (!email) throw new Error("Email required");

        // Use Env Vars for Keys
        const WHOP_KEY = env.WHOP_API_KEY; 
        const RESEND_KEY = env.RESEND_API_KEY;

        // Check Whop Subscription
        const whopRes = await fetch(`https://api.whop.com/v1/memberships?email=${encodeURIComponent(email)}&company_id=${env.WHOP_COMPANY_ID}`, {
            headers: { 'Authorization': `Bearer ${WHOP_KEY}` }
        });
        const whopData = await whopRes.json();
        
        const hasAccess = whopData.data && whopData.data.some(m => 
            ['active', 'trialing', 'completed'].includes(m.status)
        );

        // Admin Bypass (Optional: Add ADMIN_EMAIL to env)
        if (!hasAccess && email !== env.ADMIN_EMAIL) {
          return new Response(JSON.stringify({ 
            message: "No active MetaStar Pro subscription found." 
            }), { status: 403, headers: corsHeaders });
        }

        // Generate & Store Code
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        await env.AUTH_DB.put(`otp:${email}`, code, { expirationTtl: 300 });

        // Send Email
        await fetch("https://api.resend.com/emails", {
          method: "POST",
          headers: { "Authorization": `Bearer ${RESEND_KEY}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            from: "MetaStar Verification <onboarding@resend.dev>",
            to: email,
            subject: `Your Verification Code: ${code}`,
            html: `
            <div style="font-family: sans-serif; background:#09090b; color:#fff; padding:30px; border-radius:10px; text-align:center;">
                <h2 style="margin-top:0; color:#eee;">MetaStar Pro</h2>
                <p style="color:#aaa;">Use the code below to access your workspace:</p>
                <div style="background:#111; display:inline-block; padding:15px 30px; border:1px solid #333; border-radius:8px; margin:20px 0;">
                    <span style="color:#dfff00; font-size:32px; letter-spacing:8px; font-weight:bold;">${code}</span>
                </div>
                <p style="font-size:12px; color:#555; margin-top:20px;">If you didn't request this, ignore this email.</p>
              </div>`
          })
        });

        return new Response(JSON.stringify({ success: true }), { headers: corsHeaders });

      } catch (e) {
        return new Response(JSON.stringify({ message: e.message || "Server Error" }), { status: 500, headers: corsHeaders });
      }
    }

    // --- 2. VERIFY CODE ---
    if (url.pathname === "/auth/verify" && request.method === "POST") {
      try {
        const { email, code } = await request.json();
        const storedCode = await env.AUTH_DB.get(`otp:${email}`);
        
        if (!storedCode || storedCode !== code) {
          return new Response(JSON.stringify({ message: "Invalid code" }), { status: 403, headers: corsHeaders });
        }

        const token = crypto.randomUUID();
        // Store session for 7 days
        await env.AUTH_DB.put(`session:${token}`, email, { expirationTtl: 604800 });
        await env.AUTH_DB.delete(`otp:${email}`);

        return new Response(JSON.stringify({ token, success: true }), { headers: corsHeaders });
      } catch (e) {
        return new Response(JSON.stringify({ message: "Verification failed" }), { status: 500, headers: corsHeaders });
      }
    }

    // --- 3. SERVE CORE.JS SECURELY ---
if (url.pathname === "/core.js") {
        const authHeader = request.headers.get("Authorization");
        if (!authHeader || !authHeader.startsWith("Bearer ")) {
            return new Response("Unauthorized", { status: 401, headers: corsHeaders });
        }
        const token = authHeader.split(" ")[1];
        const userEmail = await env.AUTH_DB.get(`session:${token}`);
        if (!userEmail) return new Response("Session Expired", { status: 403, headers: corsHeaders });

        const object = await env.ASSETS_BUCKET.get("core.js");
        if (object === null) return new Response("Core file missing", { status: 404, headers: corsHeaders });

        const headers = new Headers();
        object.writeHttpMetadata(headers);
        headers.set("etag", object.httpEtag);
        headers.set("Access-Control-Allow-Origin", "*");
        headers.set("Cache-Control", "no-store"); 
        return new Response(object.body, { headers });
    }

    return new Response("Not Found", { status: 404, headers: corsHeaders });
  }
};
